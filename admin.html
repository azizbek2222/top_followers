<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOP FOLLOWERS - ADMIN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --success: #22c55e; --danger: #ef4444; --accent: #3b82f6; }
        body { font-family: sans-serif; background: var(--bg); color: white; padding: 15px; margin: 0; user-select: none; }
        h2, h3 { color: var(--accent); border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .order-item { background: var(--card); margin: 12px 0; padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent); }
        .user { color: #fbbf24; font-weight: bold; }
        .insta { color: #22c55e; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        .confirm-btn { background: var(--success); }
        .reject-btn { background: var(--danger); }
        .history-item { background: rgba(255,255,255,0.05); margin: 8px 0; padding: 10px; border-radius: 8px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <h2>üì• Yangi Buyurtmalar</h2>
    <div id="admin-orders">Yuklanmoqda...</div>

    <h3>üìú Oxirgi 10 ta Tarix</h3>
    <div id="admin-history">Tarix bo'sh.</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let orders = [];
        let history = [];

        function loadAllData() {
            tg.CloudStorage.getItem('all_orders', (err, value) => {
                orders = value ? JSON.parse(value) : [];
                renderOrders();
            });
            tg.CloudStorage.getItem('order_history', (err, value) => {
                history = value ? JSON.parse(value) : [];
                renderHistory();
            });
        }

        function renderOrders() {
            const container = document.getElementById('admin-orders');
            if (orders.length === 0) { container.innerHTML = "<p>Yangi buyurtmalar yo'q.</p>"; return; }
            container.innerHTML = orders.map((o, index) => `
                <div class="order-item">
                    <p>üë§ @${o.user} -> <span class="insta">@${o.insta}</span></p>
                    <div class="btn-group">
                        <button class="confirm-btn" onclick="processOrder(${index}, 'confirm')">‚úÖ Tasdiqlash</button>
                        <button class="reject-btn" onclick="processOrder(${index}, 'reject')">‚ùå Rad etish</button>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory() {
            const container = document.getElementById('admin-history');
            container.innerHTML = history.slice(-10).reverse().map(h => `
                <div class="history-item">@${h.user} -> @${h.insta} | <b>${h.status === 'done' ? '‚úÖ' : '‚ùå'}</b></div>
            `).join('');
        }

        function processOrder(index, action) {
            const order = orders[index];
            if (action === 'confirm') {
                history.push({...order, status: 'done'});
                tg.CloudStorage.setItem('order_history', JSON.stringify(history));
            } else {
                tg.CloudStorage.getItem('rejected_orders', (err, value) => {
                    let rejected = value ? JSON.parse(value) : [];
                    rejected.push(order);
                    tg.CloudStorage.setItem('rejected_orders', JSON.stringify(rejected));
                });
                history.push({...order, status: 'rejected'});
                tg.CloudStorage.setItem('order_history', JSON.stringify(history));
            }
            orders.splice(index, 1);
            tg.CloudStorage.setItem('all_orders', JSON.stringify(orders), () => {
                loadAllData();
                tg.HapticFeedback.notificationOccurred('success');
            });
        }
        loadAllData();
        setInterval(loadAllData, 10000);
    </script>
</body>
</html>
